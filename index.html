<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 智能待辦清單</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-50 min-h-screen p-4">
    <div class="max-w-md mx-auto bg-white rounded-2xl shadow-xl overflow-hidden p-6 border border-slate-100">
        <h1 class="text-3xl font-extrabold text-slate-800 mb-2 flex items-center">
            <span class="bg-blue-600 text-white p-2 rounded-lg mr-3"><i class="fas fa-robot"></i></span>
            AI Todo
        </h1>
        <p class="text-slate-500 text-sm mb-6">智能排程與日期衝突檢查</p>
        
        <!-- API Key -->
        <div class="mb-6 group">
            <label class="block text-slate-700 text-xs font-bold mb-1 uppercase tracking-wider">Gemini API Key</label>
            <input id="api-key" type="password" placeholder="輸入金鑰以啟用 AI 功能" 
                class="w-full px-4 py-2 bg-slate-100 border-none rounded-xl focus:ring-2 focus:ring-blue-500 transition-all outline-none text-sm">
        </div>

        <!-- Add Task -->
        <div class="bg-blue-50 p-4 rounded-2xl mb-6">
            <input id="task-input" type="text" placeholder="要做什麼？" class="w-full bg-transparent border-b-2 border-blue-200 mb-3 py-1 outline-none focus:border-blue-500 text-slate-700">
            <div class="flex gap-2">
                <input id="task-date" type="datetime-local" class="flex-1 bg-white px-3 py-1 rounded-lg text-xs border-none shadow-sm">
                <button id="add-btn" class="bg-blue-600 text-white px-4 py-1 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg">新增</button>
            </div>
        </div>

        <!-- AI Actions -->
        <div class="flex gap-2 mb-6">
            <button id="ai-arrange" class="flex-1 bg-indigo-100 text-indigo-700 py-2 rounded-xl text-sm font-bold hover:bg-indigo-200 transition flex items-center justify-center">
                <i class="fas fa-wand-magic-sparkles mr-2"></i> AI 智能排序
            </button>
        </div>

        <!-- Warning Area -->
        <div id="ai-warning" class="hidden bg-amber-50 border-l-4 border-amber-400 p-3 mb-6 rounded-r-xl">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-amber-500 mt-1 mr-3"></i>
                <p id="warning-text" class="text-xs text-amber-800 leading-relaxed"></p>
            </div>
        </div>

        <!-- Task List -->
        <div id="task-list" class="space-y-3">
            <!-- Tasks will appear here -->
        </div>
    </div>

    <script>
        let tasks = JSON.parse(localStorage.getItem('smart_tasks')) || [];
        const apiKeyInput = document.getElementById('api-key');
        const taskList = document.getElementById('task-list');
        const aiWarning = document.getElementById('ai-warning');

        apiKeyInput.value = localStorage.getItem('gemini_api_key') || '';

        function saveTasks() {
            localStorage.setItem('smart_tasks', JSON.stringify(tasks));
            renderTasks();
        }

        function renderTasks() {
            taskList.innerHTML = '';
            tasks.forEach((task, index) => {
                const div = document.createElement('div');
                div.className = "flex items-center p-4 bg-slate-50 rounded-xl border border-slate-100 group animate-fadeIn";
                div.innerHTML = `
                    <div class="flex-1">
                        <h3 class="font-bold text-slate-800 text-sm">${task.text}</h3>
                        <p class="text-[10px] text-slate-400 mt-1"><i class="far fa-clock mr-1"></i> ${task.date ? new Date(task.date).toLocaleString() : '未定時間'}</p>
                    </div>
                    <button onclick="deleteTask(${index})" class="text-slate-300 hover:text-red-500 transition p-2">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                taskList.appendChild(div);
            });
        }

        document.getElementById('add-btn').onclick = () => {
            const text = document.getElementById('task-input').value;
            const date = document.getElementById('task-date').value;
            if (!text) return;
            tasks.push({ text, date, completed: false });
            document.getElementById('task-input').value = '';
            saveTasks();
            checkConflicts();
        };

        window.deleteTask = (index) => {
            tasks.splice(index, 1);
            saveTasks();
        };

        async function callGemini(prompt) {
            const key = apiKeyInput.value;
            localStorage.setItem('gemini_api_key', key);
            if (!key) return null;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        async function checkConflicts() {
            if (tasks.length < 2) return;
            const prompt = `你是行程專家。請檢查以下待辦清單是否有時間衝突、過於擁擠或不合理的情況：${JSON.stringify(tasks)}。如果有，請簡短地（30字內）給出警告建議。如果沒有，請只回覆 "OK"。`;
            const result = await callGemini(prompt);
            if (result && !result.includes("OK")) {
                aiWarning.classList.remove('hidden');
                document.getElementById('warning-text').innerText = result;
            } else {
                aiWarning.classList.add('hidden');
            }
        }

        document.getElementById('ai-arrange').onclick = async () => {
            const btn = document.getElementById('ai-arrange');
            btn.innerText = "排序中...";
            const prompt = `你是排程專家。請根據優先級和邏輯重新排序以下 JSON 任務清單，並返回排序後的 JSON 數據格式（不要說廢話）：${JSON.stringify(tasks)}`;
            const result = await callGemini(prompt);
            if (result) {
                try {
                    const jsonMatch = result.match(/\[.*\]/s);
                    if (jsonMatch) {
                        tasks = JSON.parse(jsonMatch[0]);
                        saveTasks();
                    }
                } catch (e) { alert("AI 回傳格式錯誤"); }
            }
            btn.innerHTML = '<i class="fas fa-wand-magic-sparkles mr-2"></i> AI 智能排序';
        };

        renderTasks();
    </script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</body>
</html>
